var ChatDB=function(e){var t={};function s(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,s),i.l=!0,i.exports}return s.m=e,s.c=t,s.d=function(e,t,n){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(s.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)s.d(n,i,function(t){return e[t]}.bind(null,i));return n},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=2)}([function(e,t){var s={ational:"ate",tional:"tion",enci:"ence",anci:"ance",izer:"ize",bli:"ble",alli:"al",entli:"ent",eli:"e",ousli:"ous",ization:"ize",ation:"ate",ator:"ate",alism:"al",iveness:"ive",fulness:"ful",ousness:"ous",aliti:"al",iviti:"ive",biliti:"ble",logi:"log"},n={icate:"ic",ative:"",alize:"al",iciti:"ic",ical:"ic",ful:"",ness:""},i="[aeiouy]",r="[^aeiou][^aeiouy]*",o=i+"[aeiou]*",a="^("+r+")?"+o+r,l="^("+r+")?"+o+r+o+r,c="^("+r+")?"+i;e.exports=function(e){var t,o,u,d,g,h,p;if(e.length<3)return e;if("y"==(u=e.substr(0,1))&&(e=u.toUpperCase()+e.substr(1)),g=/^(.+?)([^s])s$/,(d=/^(.+?)(ss|i)es$/).test(e)?e=e.replace(d,"$1$2"):g.test(e)&&(e=e.replace(g,"$1$2")),g=/^(.+?)(ed|ing)$/,(d=/^(.+?)eed$/).test(e)){var f=d.exec(e);(d=new RegExp(a)).test(f[1])&&(d=/.$/,e=e.replace(d,""))}else if(g.test(e)){t=(f=g.exec(e))[1],(g=new RegExp(c)).test(t)&&(e=t,g=/(at|bl|iz)$/,h=new RegExp("([^aeiouylsz])\\1$"),p=new RegExp("^"+r+i+"[^aeiouwxy]$"),g.test(e)?e+="e":h.test(e)?(d=/.$/,e=e.replace(d,"")):p.test(e)&&(e+="e"))}if((d=/^(.+?)y$/).test(e)&&(t=(f=d.exec(e))[1],(d=new RegExp(c)).test(t)&&(e=t+"i")),(d=/^(.+?)(ational|tional|enci|anci|izer|bli|alli|entli|eli|ousli|ization|ation|ator|alism|iveness|fulness|ousness|aliti|iviti|biliti|logi)$/).test(e)&&(t=(f=d.exec(e))[1],o=f[2],(d=new RegExp(a)).test(t)&&(e=t+s[o])),(d=/^(.+?)(icate|ative|alize|iciti|ical|ful|ness)$/).test(e)&&(t=(f=d.exec(e))[1],o=f[2],(d=new RegExp(a)).test(t)&&(e=t+n[o])),g=/^(.+?)(s|t)(ion)$/,(d=/^(.+?)(al|ance|ence|er|ic|able|ible|ant|ement|ment|ent|ou|ism|ate|iti|ous|ive|ize)$/).test(e))t=(f=d.exec(e))[1],(d=new RegExp(l)).test(t)&&(e=t);else if(g.test(e)){t=(f=g.exec(e))[1]+f[2],(g=new RegExp(l)).test(t)&&(e=t)}return(d=/^(.+?)e$/).test(e)&&(t=(f=d.exec(e))[1],d=new RegExp(l),g=new RegExp("^([^aeiou][^aeiouy]*)?[aeiouy][aeiou]*[^aeiou][^aeiouy]*([aeiouy][aeiou]*)?$"),h=new RegExp("^"+r+i+"[^aeiouwxy]$"),(d.test(t)||g.test(t)&&!h.test(t))&&(e=t)),d=/ll$/,g=new RegExp(l),d.test(e)&&g.test(e)&&(d=/.$/,e=e.replace(d,"")),"y"==u&&(e=u.toLowerCase()+e.substr(1)),e}},function(e,t){!function(e){if("Intl"in e&&"Segmenter"in e.Intl)return;e.Intl=e.Intl||{};const t=["grapheme","word","sentence","line"],s={grapheme:{grapheme:/^(.|\n)/},word:{letter:/^[a-z](?:'?[a-z])*/i,number:/^\d+([,.]\d+)*/},sentence:{terminator:/^[^.?!\r\n]+[.?!]+[\r\n]?/,separator:/^[^.?!\r\n]+[\r\n]?/},line:{hard:/^\S*[\r\n]/,soft:/^\S*\s*/}};function n(e,t){const s={none:0,number:100,letter:200,kana:300,ideo:400,unknown:-1}[e]||0;switch(t){case"character":return;case"word":return e;case"sentence":return{0:"terminator",100:"separator"}[s]||e;case"line":return{0:"soft",100:"hard"}[s]||e;default:return e}}class i{constructor(e,t){this._cur=-1,this._type=void 0,this._breaks=t}[Symbol.iterator](){return this}next(){return this._cur<this._breaks.length&&++this._cur,this._cur>=this._breaks.length?(this._type=void 0,{done:!0,value:void 0}):(this._type=this._breaks[this._cur].breakType,{done:!1,value:{segment:this._breaks[this._cur].segment,breakType:this._breaks[this._cur].breakType}})}following(e){if(!this._breaks.length)return!0;if(void 0===e)this._cur<this._breaks.length&&++this._cur;else for(this._cur=0;this._cur<this._breaks.length&&this._breaks[this._cur].pos<e;++this._cur);return this._type=this._cur<this._breaks.length?this._breaks[this._cur].breakType:void 0,this._cur+1>=this._breaks.length}preceding(e){if(!this._breaks.length)return!0;if(void 0===e)this._cur>=this._breaks.length&&--this._cur,this._cur>=0&&--this._cur;else for(this._cur=this._breaks.length-1;this._cur>=0&&this._breaks[this._cur].pos>=e;--this._cur);return this._type=this._cur+1>=this._breaks.length?void 0:this._breaks[this._cur+1].breakType,this._cur<0}get position(){return this._cur<0||!this._breaks.length?this._breaks.initial:this._cur>=this._breaks.length?this._breaks[this._breaks.length-1].pos:this._breaks[this._cur].pos}get breakType(){return this._type}}e.Intl.Segmenter=class{constructor(e,s){this._locale=Array.isArray(e)?e.map(e=>String(e)):String(e||navigator.language),s=Object.assign({granularity:"grapheme"},s),this._granularity=t.includes(s.granularity)?s.granularity:"grapheme"}segment(t){return new i(t,function(t,i,r){const o=[];if("v8BreakIterator"in e.Intl){"grapheme"===i&&(i="character");const e=new self.Intl.v8BreakIterator(t,{type:i});e.adoptText(r);let s=0,a=e.next();for(;-1!==a;)o.push({pos:e.current(),segment:r.slice(s,a),breakType:n(e.breakType(),i)}),s=a,a=e.next()}else{const e=s[i];let t=0;for(;t<r.length;){let s=!1;for(let n of Object.keys(e)){const a=e[n],l=r.slice(t).match(a);if(l){t+=l[0].length,o.push({pos:t,segment:l[0],breakType:"grapheme"===i?void 0:n}),s=!0;break}}s||o.push({pos:t+1,segment:r.slice(t,++t),breakType:"none"})}}return o.initial=0,o}(this._locale,this._granularity,t))}}}(self)},function(e,t,s){"use strict";s.r(t);s(1);var n=s(0),i=s.n(n);function r(e,t){const s=new Set,n=new Intl.Segmenter(t,{type:"word"}).segment(e);for(let{segment:e,breakType:t}of n){if("none"===t)continue;let n=e;n=n.toLowerCase(),n=i()(n),s.add(n)}return Array.from(s)}var o={tokenize:r,search:function(e,t,s,n){const i=[],o=r(t,s);if(0===o.length)throw new Error("no words in query");let a=0;const l=o.map(t=>e.openKeyCursor(t));l.forEach(e=>{++a,e.onsuccess=()=>{0==--a&&function(){const e=l.map(e=>e.result);if(e.includes(null))return console.log(i,"======="),void n(i);e.sort((e,t)=>indexedDB.cmp(e.primaryKey,t.primaryKey)),0===indexedDB.cmp(e[0].primaryKey,e[e.length-1].primaryKey)?(i.push(e[0].primaryKey),a=e.length,e.forEach(e=>e.continue())):(a=1,e[0].continue())}()}})}};t.default=class{constructor(e={}){const{version:t=1,web_uid:s,callbackAfterConnected:n}=e;this.suffix=s,this.request=indexedDB&&indexedDB.open("maimai_pc_chat_"+this.suffix,t),this.db=null,this.callbackAfterConnected=n,this.init()}init(){const e=this,{request:t,callbackAfterConnected:s}=e;t.onsuccess=n=>{e.db=t.result,e.status="success"===n.type?"connected":"failed",s&&s(e.status),console.log("open success")},t.onupgradeneeded=t=>{e.status=t.type,this.db=t.target.result;const{db:s}=this;var n;s.objectStoreNames.contains("messages")||(n=s.createObjectStore("messages",{keyPath:"id"})).createIndex("id","id",{unique:!0}),s.objectStoreNames.contains("dialogues")||((n=s.createObjectStore("dialogues",{keyPath:"id"})).createIndex("id","id",{unique:!0}),n.createIndex("mid","mid",{unique:!1}),n.createIndex("text","terms",{multiEntry:!0}))}}isSupported(){return"indexedDB"in window}connect(){const{request:e}=this;return new Promise((t,s)=>{e.onsuccess=s=>{this.db=e.result,console.log("open success",s),t("success"===s.type?"connected":"failed")}})}putMessages(e,t){if(!this.db)return void console.log("this.db does not exist!!!");if("upgradeneeded"===this.status)return void console.log("action is not permitted during indexeddb is upgraded");const s=this.db.transaction(["messages"],"readwrite");e.forEach(e=>{void 0!==e.openByUser&&delete e.openByUser,s.objectStore("messages").put(e)}),s.onsuccess=e=>{console.log("数据写入成功")},s.oncomplete=e=>{console.log("数据写入完成"),t&&t()},s.onerror=e=>{console.log("数据写入失败")}}putDialogues(e,t){if(!this.db)return void console.log("this.db does not exist!!!");if("upgradeneeded"===this.status)return void console.log("action is not permitted during indexeddb is upgraded");const s=this.db.transaction(["dialogues"],"readwrite");e.forEach(e=>{if(e.terms||(e.terms=o.tokenize(e.text||"","zh")),e.mid&&e.id)try{s.objectStore("dialogues").put(e)}catch(e){console.log("===== err =====",e)}}),s.onsuccess=e=>{console.log("dlg 数据写入成功")},s.oncomplete=e=>{console.log("dlg 数据写入完成"),t&&t()},s.onerror=e=>{console.log("dlg 数据写入失败")}}readMessageByMid(e){const t=this.db.transaction(["messages"]).objectStore("messages").get(e);t.onerror=function(e){console.log("事务失败")},t.onsuccess=function(e){t.result?(console.log("Name: "+t.result.name),console.log("Age: "+t.result.age),console.log("Email: "+t.result.email)):console.log("未获得数据记录")}}readAllMessages(){const e=this,t=e.db.transaction(["messages"]).objectStore("messages"),s=[];return new Promise(n=>{t.openCursor(null,"prev").onsuccess=function(t){const i=t.target.result;if(i&&s.length<3e3){const t=i.value;if(t&&void 0!==t.openByUser&&delete i.value.openByUser,t&&Array.isArray(t.latest_dialogs)&&t.latest_dialogs.length){const s=t.latest_dialogs;s.sort((e,t)=>e.id-t.id),t.latest_dialogs=e.sliceDialogsWhenMissed(s)}t.local_info&&"suc"!==t.local_info.status&&(t.local_info.status="suc"),s.push(t),i.continue()}else n(s)}})}readMessages(e,t){const s=this.db.transaction(["messages"]).objectStore("messages"),n=[],i=e*t,r=(e+1)*t;let o=0;return new Promise(e=>{s.openCursor().onsuccess=function(t){var s=t.target.result;s&&i<=o&&o<r?(console.log("id: "+s.key),console.log("Name: "+s.value.id),o++,n.push(s.value),s.continue()):(console.log("没有更多数据了！",n.length),console.log("没有更多数据了！",n.length),e(n))}})}read(){var e=this.db.transaction(["messages"]).objectStore("messages").get(780280784);e.onerror=function(e){console.log("事务失败")},e.onsuccess=function(t){e.result?console.log("Name: "+e.result.id):console.log("未获得数据记录")}}getDialoguesByMid(e,t=1,s=100){const n=this;if(!n.db)return console.log("this.db does not exist!!!"),new Promise(e=>e([]));const i=n.db.transaction(["dialogues"],"readonly").objectStore("dialogues").index("mid"),r=[];return new Promise(o=>{i.openCursor().onsuccess=function(i){var a=i.target.result;if(a){const{value:t}=a;t&&t.mid===e&&(console.log("id: "+a.key),console.log("text: "+a.value.text),r.push(a.value)),a.continue()}else{console.log("没有更多数据了！",r.length);const i=r.sort((e,t)=>t.id-e.id).slice((t-1)*s,t*s);i.reverse();const a=n.sliceDialogsWhenMissed(i);o({mid:e,dialogs:a,hasmore:!0})}}})}searchByKeyword(e){if(!this.db)return void console.log("this.db does not exist!!!");const t=this.db.transaction(["dialogues"]).objectStore("dialogues"),s=t.index("text");return new Promise(n=>{e.map(e=>{o.search(s,e,"zh",(s,i,r)=>{console.log("query:",JSON.stringify(e),"results:",s);let o=[];s.length?s.forEach(e=>{t.get(e).onsuccess=function(e){o.push(e.target.result),o.length===s.length&&n(o)}}):n([])})})})}deleteMessage(e){if(!e)return;if(!this.db)return;if("upgradeneeded"===this.status)return;const t=this.db.transaction(["messages"],"readwrite");try{t.objectStore("messages").delete(e)}catch(e){console.warn(e)}}sliceDialogsWhenMissed(e,t="asc"){const s=e.length;let n=0;return e.some((i,r)=>{let o=r<s-1?r+1:-1;return!(o>0)||(!("asc"===t&&i.id===e[o].last_did||"desc"===t&&i.last_did===e[o].id)||(n=o,!1))}),e.slice(0,n+1)}}}]);